---
title: "irene_file"
format: html
editor: visual
---

```{r}

library(tidyverse)
load("data/elections_tidy.rda")
load("data/surveys_tidy.rda")

```


First question

Which party was the winner in the municipalities with more than 100,000 habitants (census) in each of the elections?

```{r}
# Filter
elections <- election_data_tidy
head(elections)
str(elections)

large_municipalities <- elections |>
  filter(censo > 100000)

# Winning parties
winners <- large_municipalities |> 
  group_by(date, municipio) |> 
  slice_max(votes, n = 1, with_ties = FALSE) |> 
  select(date, party_recoded, municipio, censo)

# Number of municipalities won
winners_by_party <- winners |> 
  group_by(date, party_recoded)|> 
  summarize(num_municipalities = n(), .groups = "drop") |> 
  arrange(date, desc(num_municipalities))


```


```{r}
# Modificar el dataframe para que "date" sea un factor con solo las fechas presentes en los datos
winners$date <- factor(winners$date, levels = unique(winners$date))

# Crear el heatmap con los cambios
ggplot(winners, aes(x = date, y = municipio, fill = party_recoded)) +
  geom_tile(color = "white") +
  scale_fill_manual(
    values = c(
      "PARTIDO POPULAR" = "#1db4e8",
      "PARTIDO SOCIALISTA OBRERO ESPAÑOL" = "#c30505",
      "OTHER" = "gray60",
      "PODEMOS" = "#a444b4",
      "VOX" = "#83b431",
      "EUZKO ALDERDI JELTZALEA-PARTIDO NACIONALISTA VASCO" = "darkgreen",
      "CONVERGENCIA I UNIO" = "#1b348a"
    )
  ) +
  labs(
    title = "PARTY WINNERS BY MUNICIPALITY AND ELECTION",
    x = "Date of election",
    y = "Municipality",
    fill = "PARTY WINNER"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5), 
    axis.title.x = element_text(size = 10), 
    axis.title.y = element_text(size = 10), 
    axis.text.x = element_text(size = 12, hjust = 1, color = "black"), 
    axis.text.y = element_text(size = 11, color = "black"), 
    legend.position = "top", 
    legend.title = element_text(size = 11), 
    legend.text = element_text(size = 9), 
    plot.margin = margin(10, 10, 10, 10) 
  )

```

```{r}

ggplot(winners_by_party, aes(x = date, y = num_municipalities, color = party_recoded)) +
  geom_line(size = 1) +
  geom_point(size = 3) +
  scale_color_manual(
    values = c(
      "PARTIDO POPULAR" = "#1db4e8",
      "PARTIDO SOCIALISTA OBRERO ESPAÑOL" = "#c30505",
      "OTHER" = "gray60",
      "PODEMOS" = "#a444b4",
      "VOX" = "#83b431",
      "EUZKO ALDERDI JELTZALEA-PARTIDO NACIONALISTA VASCO" = "darkgreen",
      "CONVERGENCIA I UNIO" = "#1b348a"
    )
  ) +
  labs(
    title = "EVOLUTION OF MUNICIPALITIES WON BY PARTIES",
    x = "Fecha de Elección",
    y = "Número de Municipios",
    color = "PARTIES"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    axis.text.x = element_text(size = 10, hjust = 1),
    axis.text.y = element_text(size = 10),
    legend.title = element_text(size = 12),
    legend.position = "top",
    legend.text = element_text(size = 10),
    plot.margin = margin(10, 10, 10, 10)
  )


```


```{r}
winners_by_party2 <- winners_by_party %>%
  mutate(party_recoded = factor(
    party_recoded,
    levels = winners_by_party %>%
      group_by(party_recoded) %>%
      summarize(total_municipios = sum(num_municipalities)) %>%
      arrange(total_municipios) %>%
      pull(party_recoded)
  ))

winners_by_party2$date <- factor(winners_by_party2$date, levels = unique(winners_by_party2$date))

# Crear el gráfico

ggplot(winners_by_party2, aes(x = date, y = num_municipalities, fill = party_recoded)) +
  geom_bar(stat = "identity") +
  geom_text(
    aes(label = num_municipalities), 
    position = position_stack(vjust = 0.5), 
    color = "black", size = 3.5
  ) +
  scale_fill_manual(
    values = c(
      "PARTIDO POPULAR" = "#1db4e8",
      "PARTIDO SOCIALISTA OBRERO ESPAÑOL" = "#c30505",
      "OTHER" = "gray60",
      "PODEMOS" = "#a444b4",
      "VOX" = "#83b431",
      "EUZKO ALDERDI JELTZALEA-PARTIDO NACIONALISTA VASCO" = "darkgreen",
      "CONVERGENCIA I UNIO" = "#1b348a"
    )
  ) +
  labs(
    title = "Número de municipios ganados por partidos en elecciones",
    x = "Fecha de Elección",
    y = "Número de Municipios Ganados",
    fill = "Partido"
  ) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial"),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 10),
    axis.title.y = element_text(size = 10),
    axis.text.x = element_text(size = 10, hjust = 1.5, color = "black"),
    axis.text.y = element_text(size = 10, color = "black"),
    legend.position = "top",
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    plot.margin = margin(10, 10, 10, 10)
  )
```


Second question

Which party was the second when the first was the PSOE? And when the first was the PP?


```{r}
ranked_votes <- elections |> 
  group_by(date, municipio) |> 
  arrange(desc(votes)) |> 
  mutate(rank = row_number()) |> 
  ungroup()

# PSOE is first
second_psoe <- ranked_votes |> 
  group_by(date, municipio) |> 
  filter(rank == 1 & siglas == "PSOE") |> 
  left_join(
    ranked_votes |> 
      filter(rank == 2) |> 
      select(date, municipio, second = siglas, votes = votes),
    by = c("date", "municipio")
  ) |> 
  ungroup()


second_psoe_sum <- second_psoe |> 
  group_by(date, second) |> 
  summarize(
    num_municipalities = n(),
    .groups = "drop"
  ) |> 
  arrange(date, desc(num_municipalities))
View(second_psoe_sum)

# PP is first
second_pp <- ranked_votes |> 
  group_by(date, municipio) |> 
  filter(rank == 1 & siglas == "PP") |> 
  left_join(
    ranked_votes |> 
      filter(rank == 2) |> 
      select(date, municipio, second = siglas, votes = votes),
    by = c("date", "municipio")
  ) |> 
  ungroup()



second_pp_sum <- second_pp |> 
  group_by(date, second) |> 
  summarize(
    num_municipalities = n(),
    .groups = "drop"
  ) |> 
  arrange(date, desc(num_municipalities))

head(second_pp_sum)
```

```{r}
second_combined <- bind_rows(
  second_pp_sum %>% mutate(first = "PP"),
  second_psoe_sum %>% mutate(first = "PSOE")
)

second_combined$date <- factor(second_combined$date, levels = unique(second_combined$date))

# Gráfico de barras apiladas con facets
ggplot(second_combined, aes(x = date, y = num_municipalities, fill = second)) +
  geom_bar(stat = "identity", position = "stack", color = "black") +
  scale_fill_manual(
    values = c(
      "PP" = "#1db4e8",
      "PSOE" = "#c30505",
      "NA" = "gray60",
      "PODEMOS" = "#a444b4",
      "EAJ-PNV" = "darkgreen",
      "BNG" = "lightblue",
      "C's" = "orange"
    )
  ) +
  labs(
    title = "Second places when PSOE or PP were first",
    x = "Election Date",
    y = "Number of Municipalities",
    fill = "Second Party"
  ) +
  facet_wrap(~ first, scales = "free_y", labeller = labeller(first = c(PP = "PP First", PSOE = "PSOE First"))) +
  theme_minimal() +
  theme(
    text = element_text(family = "Arial"),
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 14),
    axis.title.y = element_text(size = 14),
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1),
    axis.text.y = element_text(size = 12),
    legend.position = "top",
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    strip.text = element_text(size = 14, face = "bold")
  )

```



