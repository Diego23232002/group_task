---
title: "pablo_changes"
author: "Pablo Aísa"
format: html
editor: visual
---
Data
```{r}

library(tidyverse)

load("data/elections_tidy.rda")
load("data/surveys_tidy.rda")
```

First question

Which party was the winner in the municipalities with more than 100,000 habitants (census) in each of the elections?

```{r}

# Filter
elections <- election_data_tidy |> 
  group_by(date, municipio, party_recoded) |> 
  mutate(votes_recoded = sum(votes, na.rm = TRUE))

head(elections)
str(elections)

large_municipalities <- elections |>
  filter(censo > 100000)

# Winning parties
winners <- large_municipalities |> 
  group_by(date, municipio) |> 
  slice_max(votes, n = 1, with_ties = FALSE) |> 
  ungroup()

# Number of municipalities won
elections_winners <- winners |> 
  group_by(date, party_recoded)|> 
  summarize(num_municipalities = n(), .groups = "drop") |> 
  arrange(date, desc(num_municipalities))

```

Second question

Which party was the second when the first was the PSOE? And when the first was the PP?

```{r}

ranked_votes <- elections |> 
  group_by(date, municipio) |> 
  arrange(desc(votes)) |> 
  mutate(rank = row_number()) |> 
  ungroup()

# PSOE is first
second_psoe <- ranked_votes |> 
  group_by(date, municipio) |> 
  filter(rank == 1 & party_recoded == "PARTIDO SOCIALISTA OBRERO ESPAÑOL") |> 
  left_join(
    ranked_votes |> 
      filter(rank == 2) |> 
      select(date, municipio, second = party_recoded, votes = votes),
    by = c("date", "municipio")
  ) |> 
  ungroup()

second_psoe_sum <- second_psoe |> 
  group_by(date, second) |> 
  summarize(
    num_municipalities = n(),
    .groups = "drop"
  ) |> 
  arrange(date, desc(num_municipalities))

# PP is first
second_pp <- ranked_votes |> 
  group_by(date, municipio) |> 
  filter(rank == 1 & party_recoded == "PARTIDO POPULAR") |> 
  left_join(
    ranked_votes |> 
      filter(rank == 2) |> 
      select(date, municipio, second = party_recoded, votes = votes),
    by = c("date", "municipio")
  ) |> 
  ungroup()

second_pp_sum <- second_pp |> 
  group_by(date, second) |> 
  summarize(
    num_municipalities = n(),
    .groups = "drop"
  ) |> 
  arrange(date, desc(num_municipalities))

```

Cataluña elections
```{r}
new_parties <- c("JUNTS PER CATALUNYA-JUNTS", 
                 "CONVERGÈNCIA DEMOCRÀTICA DE CATALUNYA")

catalunya <- election_data_tidy |> 
  mutate(party_recoded = 
           case_when(party %in% new_parties ~ party, 
                     TRUE ~ party_recoded))

catalunya <- catalunya |> 
  filter(codigo_ccaa == "09") |> 
  group_by(date, municipio, party_recoded) |>
  mutate(votes_recoded = sum(votes, na.rm = TRUE))

catalunya_votes <- catalunya |> 
  group_by(date, party_recoded) |> 
  summarize(total_votes = sum((votes_recoded)), .groups = "drop")

# Crear el gráfico de evolución de los votos por partido
g <- ggplot(catalunya_votes, aes(x = date, y = total_votes, color = party_recoded, group = party_recoded)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Evolución de los Votos de los Partidos en Cataluña",
    x = "Año de Elección",
    y = "Total de Votos",
    color = "Partido"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

